var maps_limit=0,maps_config={},maps={},maps_type={},maps_layer={},maps_timeout={},maps_loaded={},maps_mypos_marker={},map_sigmet_colors={CLD:"#595b64",CONV:"#aa66ff",DS:"#eebb55",FC:"#aa66ff",GR:"#ff2200",ICE:"#4488dd",MTW:"#44aa44",SS:"#eebb55",TC:"#dd66ee",TDO:"#ff2200",TS:"#ff2200",TSGR:"#ff2200",TURB:"#ee8844",VA:"#595b64",WTSPT:"#4488dd"};!function(a){var o=o=>{let e=maps[o].getSize();(e.x<600||e.y<400)&&a('[uuid="'+o+'"]').addClass("mini-map micro-map"),e.x<900||e.y<600?a('[uuid="'+o+'"]').addClass("mini-map"):a('[uuid="'+o+'"]').removeClass("mini-map micro-map")},e=o=>{let e=maps[o].getCenter(),t=maps[o].getZoom();use_cookies&&a.cookie("apm_lastpos",JSON.stringify({lat:e.lat,lon:e.lng,zoom:t})),location.hash=t+"/"+e.lat.toFixed(4)+"/"+e.lng.toFixed(4)},t=(a,o=!1)=>{maps_layer[a].halo&&maps[a].removeLayer(maps_layer[a].halo),!1!==o&&(maps_layer[a].halo=L.marker(o,{icon:L.divIcon({iconSize:[72,72],iconAnchor:[36,36],className:"halo",html:"<halo></halo>"})}).addTo(maps[a]))},i=o=>{let e=maps[o].getZoom();a("#"+o).attr("zoom",e),a('[uuid="'+o+'"] [map-action="zoom-in"]').prop("disabled",!1),a('[uuid="'+o+'"] [map-action="zoom-out"]').prop("disabled",!1),a('[uuid="'+o+'"] [map-action="navaids"]').hide(),a('[uuid="'+o+'"] [map-action="waypoints"]').hide(),e<=(maps_config[o].minZoom||4)&&a('[uuid="'+o+'"] [map-action="zoom-out"]').prop("disabled",!0),e>=(maps_config[o].maxZoom||15)&&a('[uuid="'+o+'"] [map-action="zoom-in"]').prop("disabled",!0),e>=10&&"airport"==maps_type[o]&&(a('[uuid="'+o+'"] [map-action="navaids"]').show(),a('[uuid="'+o+'"] [map-action="waypoints"]').show())},s=(a,o,e=!1)=>{maps[a].removeLayer(maps_layer[a][o]),delete maps_layer[a][o],e&&(clearTimeout(maps_timeout[a][o]),clearInterval(maps_timeout[a][o]))},n=o=>{"marker"in maps_timeout[o]&&clearTimeout(maps_timeout[o].marker);let e=maps[o],t=e.getBounds(),i=maps_layer[o].marker,s={token:get_token(),limit:maps_limit,bounds:{lat:[t.getNorth(),t.getSouth()],lon:[t.getEast(),t.getWest()]},navaids:+!!(e.getZoom()>=10&&1==(maps_config[o].navaids||a.cookie("apm_navaids")||0)),waypoints:+!!(e.getZoom()>=10&&1==(maps_config[o].waypoints||a.cookie("apm_waypoints")||0))};"query"in maps_config[o]&&(s={...s,...maps_config[o].query}),a.ajax({url:apiurl+maps_type[o]+"_layer.php",type:"post",data:s,success:a=>{let e=JSON.parse(a);i.clearLayers(),"navaids"in e.response&&Object.values(e.response.navaids).forEach((a=>{i.addLayer(L.marker(L.latLng(parseFloat(a.lat),parseFloat(a.lon)),{icon:L.divIcon({iconSize:[24,24],iconAnchor:[12,12],className:"navaid-"+a.type,html:"<navicon></navicon>"})}).bindTooltip('<div class="IDENT">'+a.ident+'</div><div class="freq">'+a.type+" "+freq_format(a.frequency)+"</div>",{className:"tooltip-navaid",direction:"center",opacity:1}).on("click",(e=>{l(e,o,a)})))})),"waypoints"in e.response&&Object.values(e.response.waypoints).forEach((a=>{i.addLayer(L.marker(L.latLng(parseFloat(a.lat),parseFloat(a.lon)),{interactive:!1,icon:L.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:"waypoint",html:"<wpicon></wpicon>"})}).bindTooltip('<div class="IDENT">'+a.ident+"</div>",{className:"tooltip-waypoint",direction:"center",permanent:!0,opacity:1}))})),"airports"in e.response&&Object.values(e.response.airports).forEach((a=>{i.addLayer(L.marker(L.latLng(parseFloat(a.lat),parseFloat(a.lon)),{icon:L.divIcon({iconSize:[20,20],iconAnchor:[10,10],className:"airport-"+a.type+" restriction-"+a.restriction,html:"<mapicon></mapicon>"})}).bindTooltip('<div class="ICAO">'+a.ICAO+'</div><div class="name">'+a.name+"</div>",{className:"tooltip-airport",direction:"center",opacity:1}).on("click",(e=>{m(e,o,a)})))})),"stations"in e.response&&Object.values(e.response.stations).forEach((a=>{i.addLayer(L.marker(L.latLng(parseFloat(a.lat),parseFloat(a.lon)),{icon:L.divIcon({iconSize:[28,28],iconAnchor:[14,14],className:"cat-"+a.cat,html:'<wxicon></wxicon><windbug style="transform: rotate( '+a.wind_dir+'deg );"></windbug><windflag class="wind-'+(null==a.wind_spd?"":Math.floor(a.wind_spd/5).toString().padStart(2,"0"))+'" style="transform: rotate( '+a.wind_dir+'deg );"></windflag>'})}).bindTooltip('<div class="ICAO">'+a.ICAO+'</div><div class="name">'+a.name+"</div>",{className:"tooltip-airport",direction:"center",opacity:1}).on("click",(e=>{m(e,o,a)})))})),"traffic"in e.response&&Object.values(e.response.traffic).forEach((a=>{i.addLayer(L.marker(L.latLng(parseFloat(a.lat),parseFloat(a.lon)),{icon:L.divIcon({iconSize:[24,24],iconAnchor:[12,12],className:"traffic t-"+a.type+(a.ground?" ground":""),html:'<tfcicon style="transform: rotate( '+a.hdg+'deg );"></tfcicon>'})}).bindTooltip('<div class="callsign">'+(a.callsign||"UNKNOWN")+'</div><div class="info"><span class="alt">'+(a.alt>1e4?"FL"+Math.floor(a.alt/100):Math.max(0,Math.round(a.alt))+"ft")+'</span><span class="velo">'+Math.round(a.velocity)+"kn</span>"+(0!=a.vrate?'<span class="vrate">VS'+(a.vrate<0?"–":"+")+Math.round(Math.abs(a.vrate))+"</span>":"")+"</div>",{className:"tooltip-traffic",direction:"center",opacity:1}).on("click",(e=>{d(e,o,a)})))})),"weather"==maps_type[o]&&(maps_timeout[o].marker=setTimeout((function(){n(o)}),3e5))}})},r=o=>{if("sigmet"in maps_layer[o]){let e=maps_layer[o].sigmet;a.ajax({url:apiurl+"sigmet_layer.php",type:"post",data:{token:get_token()},success:a=>{let t=JSON.parse(a);e.clearLayers(),Object.values(t.response.sigmets).forEach((function(a){JSON.parse(a.polygon).forEach((function(t){if("object"==typeof t&&t.length>1&&t.length==t.filter((a=>"object"==typeof a)).length){let i=map_sigmet_colors[a.hazard]||"#1b1d23",s=L.polygon(t.filter((a=>a.reverse())),{color:i,weight:1,fillOpacity:.15,dashArray:"4 4"});s.bindTooltip('<div class="hazard" style="color: '+i+';">'+a.hazard+"</div>",{className:"tooltip-sigmet",direction:"center",opacity:1,permanent:!0}),s.on("click",(e=>{c(s,e,o,a)})),e.addLayer(s)}}))})),maps_timeout[o].sigmet=setTimeout((()=>{r(o)}),6e4)}})}},p=(o,e,t="")=>{let i=a('[uuid="'+o+'"] .map-infobox');"classes"in e&&(t+=" "+e.classes),"image"in e&&null!==e.image?(t+=" image",i.find(".infobox-image").css("backgroundImage","url( "+e.image.file+" )").show(),i.find(".infobox-image-credits").html(e.image.credits)):i.find(".infobox-image").hide(),i.find(".infobox-title").html(e.title),i.find(".infobox-subtitle").html(e.subtitle),i.find(".infobox-content").html(e.content),"link"in e?(i.find(".infobox-link").attr("href",e.link).show(),i.find(".infobox-linktext").html(e.linktext)):i.find(".infobox-link").hide(),i.attr("class","map-infobox "+t).show()},m=(o,e,i)=>{a.ajax({url:apiurl+"airport_info.php",type:"post",data:{token:get_token(),locale:a.cookie("locale"),airport:i.ICAO},success:a=>{let o=JSON.parse(a);if("infobox"in o.response&&"object"==typeof o.response.infobox){let a=L.latLng(i.lat,i.lon);maps[e].flyTo(a,Math.max(8,maps[e].getZoom())),t(e,a),p(e,o.response.infobox,"airport")}}})},l=(o,e,i)=>{a.ajax({url:apiurl+"navaid_info.php",type:"post",data:{token:get_token(),locale:a.cookie("locale"),navaid:i._id},success:a=>{let o=JSON.parse(a);if("infobox"in o.response&&"object"==typeof o.response.infobox){let a=L.latLng(i.lat,i.lon);maps[e].flyTo(a,Math.max(10,maps[e].getZoom())),t(e,a),p(e,o.response.infobox,"navaid navaid-"+i.type)}}})},c=(o,e,t,i)=>{a.ajax({url:apiurl+"sigmet_info.php",type:"post",data:{token:get_token(),locale:a.cookie("locale"),sigmet:i._id},success:a=>{let e=JSON.parse(a);"infobox"in e.response&&"object"==typeof e.response.infobox&&(maps[t].fitBounds(o.getBounds(),{maxZoom:maps_config[t].maxZoom||15,padding:[50,50]}),p(t,e.response.infobox,"sigmet-"+i.hazard))}})},d=(o,e,i)=>{a.ajax({url:apiurl+"traffic_info.php",type:"post",data:{token:get_token(),locale:a.cookie("locale"),ident:i.ident},success:a=>{let o=JSON.parse(a);if("infobox"in o.response&&"object"==typeof o.response.infobox){let a=L.latLng(i.lat,i.lon);maps[e].flyTo(a,Math.max(8,maps[e].getZoom())),t(e,a),p(e,o.response.infobox,"traffic")}}})},f=a=>{"terminator"in maps_layer[a]&&(maps_layer[a].terminator.setTime(),maps_timeout[a].terminator=setTimeout((()=>{f(a)}),250))};a(document).ready((function(){maps_limit="userAgentData"in navigator&&"mobile"in navigator.userAgentData?40:(navigator.hardwareConcurrency||4)<2||(navigator.deviceMemory||2)<1?60:100,a("[map-data]").each((function(){let t=JSON.parse(window.atob(a(this).attr("map-data"))||"{}"),s=get_token(),r={};r="position"in t?t.position:(pos=a.cookie("apm_lastpos")||!1)?JSON.parse(pos):{lat:40.7,lon:-74,zoom:6},a(this).attr("id",s).removeAttr("map-data"),a(this).closest(".map-container").attr("uuid",s),maps_config[s]=t,maps_layer[s]={},maps_timeout[s]={},maps_type[s]=t.type||a.cookie("apm_map_type")||"airport",maps[s]=L.map(s,{center:[r.lat||0,r.lon||0],zoom:r.zoom||6,maxBounds:L.latLngBounds(L.latLng(-90,-180),L.latLng(90,180)),maxBoundsViscosity:1,preferCanvas:t.preferCanvas||!0,scrollWheelZoom:t.wheelZoom||!0,zoomControl:!1}),L.tileLayer("https://{s}.basemaps.cartocdn.com/"+{light:"light_all",dark:"dark_all"}[a.cookie("theme")||"light"]+"/{z}/{x}/{y}@2x.png",{minZoom:t.minZoom||4,maxZoom:t.maxZoom||15,attribution:'© <a href="https://osm.org">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a> | Data by <a href="'+baseurl+'">airportmap.de</a>',subdomains:"abcd"}).addTo(maps[s]),L.control.scale({maxWidth:140}).addTo(maps[s]),maps_layer[s].marker=L.layerGroup().addTo(maps[s]),"supress_day_night"in t&&t.supress_day_night||1!=(a.cookie("apm_day_night")||0)||a('[map-action="day-night"]').click(),"supress_sigmets"in t&&t.supress_sigmets||1!=(a.cookie("apm_sigmet")||0)||a('[map-action="sigmet"]').click(),"navaids"in t&&!t.navaids||1!=(a.cookie("apm_navaids")||0)||a('[map-action="navaids"]').click(),"waypoints"in t&&!t.waypoints||1!=(a.cookie("apm_waypoints")||0)||a('[map-action="waypoints"]').click(),t.save_position&&(e(s),maps[s].on("moveend",(()=>{e(s)}))),maps[s].on("moveend",(()=>{s in maps_loaded&&n(s)})),maps[s].on("zoomend",(()=>{i(s)})),"fit_bounds"in t&&maps[s].fitBounds(t.fit_bounds,{animate:!1}),"marker"in t&&t.marker.forEach((a=>{L.marker([a.lat,a.lon],{icon:L.divIcon({iconSize:[24,24],iconAnchor:[12,12],className:"mypos",html:"<mapicon></mapicon>"})}).addTo(maps[s])})),o(s),setTimeout((function(){["airport","weather"].includes(maps_type[s])?a('[uuid="'+s+'"] [map-action="type"][map-type="'+maps_type[s]+'"]').click():n(s),i(s),maps_loaded[s]=!0}),250)}))})),a(document).on("click","[map-action]",(function(o){prevent(o);let e=a(this).closest(".map-container").find(".map").attr("id"),p=maps[e];switch((a(this).attr("map-action")||"").trim().toLowerCase()){case"zoom-in":p.zoomIn();break;case"zoom-out":p.zoomOut();break;case"type":let o=a(this).attr("map-type");a('[map-action="type"]').removeClass("active"),a(this).addClass("active"),use_cookies&&"save_type"in maps_config[e]&&maps_config[e].save_type&&a.cookie("apm_map_type",o),maps_type[e]=o,i(e),n(e);break;case"navaids":a(this).toggleClass("active"),use_cookies&&a.cookie("apm_navaids",+!!a(this).hasClass("active")),n(e);break;case"waypoints":a(this).toggleClass("active"),use_cookies&&a.cookie("apm_waypoints",+!!a(this).hasClass("active")),n(e);break;case"sigmet":a(this).toggleClass("active"),(o=>{let e=0;"sigmet"in maps_layer[o]?s(o,"sigmet",!0):(e=1,maps_layer[o].sigmet=L.layerGroup().addTo(maps[o]),r(o)),use_cookies&&a.cookie("apm_sigmet",e)})(e);break;case"day-night":a(this).toggleClass("active"),(o=>{let e=0;"terminator"in maps_layer[o]?s(o,"terminator",!0):(e=1,maps_layer[o].terminator=L.terminator(),maps_layer[o].terminator.addTo(maps[o]),maps_layer[o].terminator.bringToBack(),f(o)),use_cookies&&a.cookie("apm_day_night",e)})(e);break;case"mypos":navigator.geolocation.getCurrentPosition((a=>{let o=new L.LatLng(a.coords.latitude,a.coords.longitude);p.setView(o,8),maps_mypos_marker[e]||(maps_mypos_marker[e]=!0,L.marker(o,{icon:L.divIcon({iconSize:[24,24],iconAnchor:[12,12],className:"mypos",html:"<mapicon></mapicon>"})}).addTo(p))}));break;case"close-infobox":a('[uuid="'+e+'"] .map-infobox').attr("class","map-infobox").hide(),t(e);break;case"scroll-below":a("html, body").animate({scrollTop:p._size.y},"fast");break}})),a(window).resize((function(){Object.keys(maps).forEach((a=>{o(a)}))}))}(jQuery);